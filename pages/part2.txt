
export const PrefectureSpots: React.FC<{ area: string; onNavigate: (path: string) => void }> = ({ area, onNavigate }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('ã™ã¹ã¦');
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  const [areaSpots, setAreaSpots] = useState<Spot[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const categoryMap: { [key: string]: string } = {
    'æ­´å²': 'History',
    'è‡ªç„¶': 'Nature',
    'ã‚°ãƒ«ãƒ¡': 'Food',
    'è¦³å…‰': 'Tourism',
    'ä½“é¨“': 'Experience',
    'ã‚¤ãƒ™ãƒ³ãƒˆ': 'Event',
    'æ¸©æ³‰': 'HotSpring',
    'çµ¶æ™¯': 'ScenicView',
    'ã‚«ãƒ•ã‚§': 'Cafe',
    'å®¿æ³Š': 'Hotel',
    'ãŠé…’': 'Drink',
    'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³': 'Fashion',
    'ãƒ‡ãƒ¼ãƒˆ': 'Date',
    'ãƒ‰ãƒ©ã‚¤ãƒ–': 'Drive',
    'æ–‡åŒ–ä½“é¨“': 'Culture',
    'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°': 'Shopping',
    'ã‚¢ãƒ¼ãƒˆ': 'Art'
  };

  useEffect(() => {
    const fetchSpots = async () => {
      try {
        setIsLoading(true);
        setError(null);
        const fetchedSpots = await spotApi.getSpotsByArea(area);
        setAreaSpots(fetchedSpots);
      } catch (err: any) {
        console.error('Failed to fetch spots:', err);
        setError(err.detail || err.message || 'ã‚¹ãƒãƒƒãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        if (AppConfig.IS_DEMO_MODE) {
          const filtered = spots.filter(s => s.area === area || area === 'Kyoto');
          setAreaSpots(filtered);
        }
      } finally {
        setIsLoading(false);
      }
    };

    fetchSpots();
  }, [area]);

  const filteredSpots = useMemo(() => {
    return areaSpots.filter(s => {
      const matchSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        s.description.toLowerCase().includes(searchTerm.toLowerCase());

      let matchCategory = true;
      if (selectedCategory !== 'ã™ã¹ã¦') {
        const mappedCat = categoryMap[selectedCategory];
        matchCategory = s.category === mappedCat;
      }

      return matchSearch && matchCategory;
    });
  }, [areaSpots, searchTerm, selectedCategory]);

  const handleFavorite = (e: React.MouseEvent) => {
    e.stopPropagation();
    alert('ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆãƒ‡ãƒ¢ï¼‰');
  };

  const toggleSelection = (id: string) => {
    setSelectedIds(prev =>
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const handleCreatePlan = () => {
    localStorage.setItem(AppConfig.STORAGE_KEYS.PENDING_SPOTS, JSON.stringify(selectedIds));
    onNavigate('/create');
  };

  if (isLoading) {
    return (
      <div className="max-w-7xl mx-auto px-4 py-10">
        <div className="flex justify-center items-center min-h-[400px]">
          <div className="text-center">
            <div className="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-text-muted">ã‚¹ãƒãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error && !AppConfig.IS_DEMO_MODE) {
    return (
      <div className="max-w-7xl mx-auto px-4 py-10">
        <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
          <p className="text-red-600 font-bold mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
          <p className="text-red-500 text-sm">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-8 py-10 pb-32">
      <header className="mb-8">
        <h1 className="text-5xl md:text-6xl font-bold mb-2">{area}</h1>
        <p className="text-text-muted">åƒå¹´ã®éƒ½ã§ã€å¿ƒã«æ®‹ã‚‹æ—…ã‚’ã€‚</p>
      </header>

      <div className="flex flex-col md:flex-row gap-4 mb-8">
        <div className="flex-grow relative">
          <span className="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-text-muted">search</span>
          <input
            type="text"
            placeholder="æ°—ã«ãªã‚‹ã‚¹ãƒãƒƒãƒˆã‚’æ¤œç´¢ï¼"
            className="w-full pl-12 pr-4 py-3 rounded-full border-none bg-white shadow-sm focus:ring-2 focus:ring-primary"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        <div className="flex-shrink-0 relative w-full md:w-48">
          <select className="w-full appearance-none pl-4 pr-10 py-3 rounded-full border-none bg-white shadow-sm focus:ring-2 focus:ring-primary">
            <option>äººæ°—é †</option>
            <option>ãŠã™ã™ã‚é †</option>
          </select>
          <span className="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-text-muted">expand_more</span>
        </div>
      </div>

      <div className="flex gap-3 overflow-x-auto pb-4 mb-6 scrollbar-hide">
        {['ã™ã¹ã¦', 'æ­´å²', 'è‡ªç„¶', 'ã‚°ãƒ«ãƒ¡', 'æ–‡åŒ–ä½“é¨“', 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', 'ã‚¢ãƒ¼ãƒˆ'].map((cat, i) => (
          <button
            key={i}
            onClick={() => setSelectedCategory(cat)}
            className={`px-6 py-2 rounded-full whitespace-nowrap font-medium text-sm transition-colors ${selectedCategory === cat ? 'bg-primary text-white shadow-md' : 'bg-white border border-gray-200 hover:border-primary text-text-light'}`}
          >
            {cat}
          </button>
        ))}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {filteredSpots.length > 0 ? (
          filteredSpots.map(spot => {
            const isSelected = selectedIds.includes(spot.id);
            return (
              <div
                key={spot.id}
                onClick={() => toggleSelection(spot.id)}
                className={`bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 group border cursor-pointer relative ${isSelected ? 'ring-4 ring-primary ring-offset-2 border-primary' : 'border-gray-100 hover:-translate-y-1'}`}
              >
                <div className="relative aspect-[4/3] overflow-hidden">
                  <img src={spot.image} alt={spot.name} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />

                  {/* Selection Indicator Overlay */}
                  <div className={`absolute top-3 left-3 w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all z-10 ${isSelected ? 'bg-primary border-primary text-white' : 'bg-black/30 border-white text-transparent'}`}>
                    <span className="material-symbols-outlined text-lg">check</span>
                  </div>

                  <button onClick={handleFavorite} className="absolute top-3 right-3 w-10 h-10 bg-black/30 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-black/50 text-white transition-colors z-10">
                    <span className="material-symbols-outlined">bookmark</span>
                  </button>
                  <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/70 to-transparent">
                    <h3 className="text-xl font-bold text-white">{spot.name}</h3>
                  </div>
                </div>
                <div className="p-4">
                  <p className="text-sm text-text-muted mb-3 line-clamp-2">{spot.description}</p>
                  <div className="flex items-center gap-4 text-sm text-text-muted">
                    <div className="flex items-center gap-1"><span className="material-symbols-outlined text-yellow-400 fill">star</span> <span className="text-text-light font-bold">{spot.rating}</span></div>
                    <div className="flex items-center gap-1"><span className="material-symbols-outlined">schedule</span> {spot.durationMinutes}åˆ†</div>
                    <span className="px-2 py-0.5 bg-primary/10 text-primary text-xs rounded-full font-medium">{spot.category}</span>
                  </div>
                </div>
              </div>
            );
          })
        ) : (
          <div className="col-span-full text-center py-12 text-text-muted">
            <span className="material-symbols-outlined text-4xl mb-2">search_off</span>
            <p>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
          </div>
        )}
      </div>

      {/* Floating Action Bar */}
      {selectedIds.length > 0 && (
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white pl-6 pr-2 py-2 rounded-full shadow-2xl flex items-center gap-6 z-50 animate-bounce-in border border-gray-700">
          <div className="flex flex-col">
            <span className="font-bold text-sm">{selectedIds.length}ä»¶é¸æŠä¸­</span>
            <span className="text-xs text-gray-400">ãƒ—ãƒ©ãƒ³ä½œæˆã«ä½¿ç”¨</span>
          </div>
          <button
            onClick={handleCreatePlan}
            className="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-full font-bold text-sm shadow-lg transition-all flex items-center gap-2"
          >
            <span className="material-symbols-outlined">auto_awesome</span>
            ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ
          </button>
        </div>
      )}
    </div>
  );
};

export const FavoriteSpots: React.FC<{ onNavigate: (path: string) => void }> = ({ onNavigate }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedArea, setSelectedArea] = useState('ã™ã¹ã¦');
  const [selectedCategory, setSelectedCategory] = useState('ã™ã¹ã¦');
  const [sortBy, setSortBy] = useState<'rating' | 'name'>('rating');
  const [selectedIds, setSelectedIds] = useState<string[]>([]);

  // Extract unique values for filters
  const availableAreas = useMemo(() => ['ã™ã¹ã¦', ...Array.from(new Set(spots.map(s => s.area)))], []);
  const availableCategories = useMemo(() => ['ã™ã¹ã¦', ...Array.from(new Set(spots.map(s => s.category)))], []);

  // Translate categories for display if needed (Simple mapping)
  const getCategoryLabel = (cat: string) => {
    const map: { [key: string]: string } = {
      'History': 'æ­´å²', 'Nature': 'è‡ªç„¶', 'Food': 'ã‚°ãƒ«ãƒ¡',
      'Culture': 'æ–‡åŒ–', 'Shopping': 'è²·ã„ç‰©', 'Art': 'ã‚¢ãƒ¼ãƒˆ', 'Relax': 'ãƒªãƒ©ãƒƒã‚¯ã‚¹',
      'Tourism': 'è¦³å…‰', 'Experience': 'ä½“é¨“', 'Event': 'ã‚¤ãƒ™ãƒ³ãƒˆ', 'HotSpring': 'æ¸©æ³‰',
      'ScenicView': 'çµ¶æ™¯', 'Cafe': 'ã‚«ãƒ•ã‚§', 'Hotel': 'å®¿æ³Š', 'Drink': 'ãŠé…’',
      'Fashion': 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³', 'Date': 'ãƒ‡ãƒ¼ãƒˆ', 'Drive': 'ãƒ‰ãƒ©ã‚¤ãƒ–'
    };
    return map[cat] || cat;
  };

  const filteredSpots = useMemo(() => {
    let result = spots.filter(s => {
      const matchSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        s.description.toLowerCase().includes(searchTerm.toLowerCase());
      const matchArea = selectedArea === 'ã™ã¹ã¦' || s.area === selectedArea;
      const matchCategory = selectedCategory === 'ã™ã¹ã¦' || s.category === selectedCategory;

      return matchSearch && matchArea && matchCategory;
    });

    if (sortBy === 'rating') {
      result.sort((a, b) => b.rating - a.rating);
    } else {
      result.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
    }

    return result;
  }, [searchTerm, selectedArea, selectedCategory, sortBy]);

  const toggleSelection = (e: React.MouseEvent, id: string) => {
    e.stopPropagation();
    setSelectedIds(prev =>
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const handleCreatePlan = () => {
    // Store selected spots in localStorage to pass to CreatePlan page
    localStorage.setItem(AppConfig.STORAGE_KEYS.PENDING_SPOTS, JSON.stringify(selectedIds));
    onNavigate('/create');
  };

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-8 py-10 pb-32">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
          <h1 className="text-3xl md:text-4xl font-black text-text-light mb-2">ãŠæ°—ã«å…¥ã‚Šã‚¹ãƒãƒƒãƒˆ</h1>
          <p className="text-text-muted">ä¿å­˜ã—ãŸã‚¹ãƒãƒƒãƒˆã‚’ã‚¨ãƒªã‚¢ã‚„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§æ•´ç†ã—ã¦ã€æ¬¡ã®æ—…ã«å‚™ãˆã¾ã—ã‚‡ã†ã€‚</p>
        </div>
        <div className="flex gap-2">
          <button className="bg-primary/10 text-primary px-4 py-2 rounded-full font-bold text-sm hover:bg-primary/20 transition-colors">
            {filteredSpots.length} ä»¶ã®ã‚¹ãƒãƒƒãƒˆ
          </button>
          {selectedIds.length > 0 && (
            <button onClick={() => setSelectedIds([])} className="text-text-muted hover:text-text-light px-4 py-2 text-sm">
              é¸æŠè§£é™¤
            </button>
          )}
        </div>
      </div>

      {/* Filters Section */}
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8 space-y-6">
        {/* Search & Sort */}
        <div className="flex flex-col md:flex-row gap-4">
          <div className="flex-grow relative">
            <span className="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-text-muted">search</span>
            <input
              type="text"
              placeholder="ã‚¹ãƒãƒƒãƒˆåã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢"
              className="w-full pl-12 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          <div className="flex-shrink-0 relative min-w-[200px]">
            <select
              value={sortBy}
              onChange={(e) => setSortBy(e.target.value as any)}
              className="w-full appearance-none pl-4 pr-10 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary focus:border-transparent"
            >
              <option value="rating">è©•ä¾¡ãŒé«˜ã„é †</option>
              <option value="name">åå‰é †</option>
            </select>
            <span className="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-text-muted">sort</span>
          </div>
        </div>

        <div className="h-px bg-gray-100" />

        {/* Cross Filters */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="text-xs font-bold text-text-muted uppercase tracking-wider mb-3 block">ã‚¨ãƒªã‚¢ã§çµã‚Šè¾¼ã¿</label>
            <div className="flex flex-wrap gap-2">
              {availableAreas.map(area => (
                <button
                  key={area}
                  onClick={() => setSelectedArea(area)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${selectedArea === area
                    ? 'bg-secondary text-text-light shadow-sm ring-2 ring-secondary ring-offset-1'
                    : 'bg-gray-50 text-text-muted hover:bg-gray-100'
                    }`}
                >
                  {area}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="text-xs font-bold text-text-muted uppercase tracking-wider mb-3 block">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§çµã‚Šè¾¼ã¿</label>
            <div className="flex flex-wrap gap-2">
              {availableCategories.map(cat => (
                <button
                  key={cat}
                  onClick={() => setSelectedCategory(cat)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${selectedCategory === cat
                    ? 'bg-primary text-white shadow-md ring-2 ring-primary ring-offset-1'
                    : 'bg-gray-50 text-text-muted hover:bg-gray-100'
                    }`}
                >
                  {cat !== 'ã™ã¹ã¦' && (
                    <span className="material-symbols-outlined text-sm">
                      {cat === 'Food' ? 'restaurant' : cat === 'Shopping' ? 'shopping_bag' : cat === 'Nature' ? 'forest' : cat === 'History' ? 'temple_buddhist' : 'local_activity'}
                    </span>
                  )}
                  {getCategoryLabel(cat)}
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in">
        {filteredSpots.length > 0 ? (
          filteredSpots.map(spot => (
            <div
              key={spot.id}
              onClick={(e) => toggleSelection(e, spot.id)}
              className={`bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 group border flex flex-col cursor-pointer relative ${selectedIds.includes(spot.id) ? 'ring-4 ring-primary ring-offset-2 border-primary' : 'border-gray-100 hover:-translate-y-1'}`}
            >
              <div className="relative aspect-[16/9] overflow-hidden">
                <img src={spot.image} alt={spot.name} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />

                {/* Selection Indicator */}
                <div className={`absolute top-3 left-3 w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all ${selectedIds.includes(spot.id) ? 'bg-primary border-primary text-white' : 'bg-black/30 border-white text-transparent'}`}>
                  <span className="material-symbols-outlined text-lg">check</span>
                </div>

                <div className="absolute top-3 right-3">
                  <button className="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform" title="ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤">
                    <span className="material-symbols-outlined fill">bookmark</span>
                  </button>
                </div>
                <div className="absolute bottom-3 left-3">
                  <span className="px-3 py-1 bg-black/50 backdrop-blur-sm text-white text-xs font-bold rounded-full border border-white/20">
                    {spot.area}
                  </span>
                </div>
              </div>
              <div className="p-5 flex-1 flex flex-col">
                <div className="flex justify-between items-start mb-2">
                  <h3 className="text-lg font-bold text-text-light line-clamp-1">{spot.name}</h3>
                  <div className="flex items-center gap-1 text-yellow-500 text-sm font-bold bg-yellow-50 px-2 py-1 rounded-md">
                    <span className="material-symbols-outlined text-sm fill">star</span> {spot.rating}
                  </div>
                </div>
                <p className="text-sm text-text-muted mb-4 line-clamp-2 flex-1">{spot.description}</p>

                <div className="flex items-center justify-between mt-auto pt-4 border-t border-gray-50">
                  <div className="flex items-center gap-2 text-xs font-medium text-primary bg-primary/5 px-3 py-1 rounded-full">
                    <span className="material-symbols-outlined text-sm">
                      {spot.category === 'Food' ? 'restaurant' : spot.category === 'Shopping' ? 'shopping_bag' : spot.category === 'Nature' ? 'forest' : spot.category === 'History' ? 'temple_buddhist' : 'local_activity'}
                    </span>
                    {getCategoryLabel(spot.category)}
                  </div>
                  <div className="text-xs text-text-muted flex items-center gap-1">
                    <span className="material-symbols-outlined text-sm">schedule</span> {spot.durationMinutes}åˆ†
                  </div>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div className="col-span-full py-20 text-center">
            <div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <span className="material-symbols-outlined text-4xl text-gray-400">filter_list_off</span>
            </div>
            <h3 className="text-xl font-bold text-text-light mb-2">æ¡ä»¶ã«åˆã†ã‚¹ãƒãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
            <p className="text-text-muted mb-6">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€æ–°ã—ã„ã‚¹ãƒãƒƒãƒˆã‚’æ¢ã—ã«è¡Œãã¾ã—ã‚‡ã†ã€‚</p>
          </div>
        )}
      </div>

      {/* Floating Action Bar */}
      {selectedIds.length > 0 && (
        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white pl-6 pr-2 py-2 rounded-full shadow-2xl flex items-center gap-6 z-50 animate-bounce-in border border-gray-700">
          <div className="flex flex-col">
            <span className="font-bold text-sm">{selectedIds.length}ä»¶é¸æŠä¸­</span>
            <span className="text-xs text-gray-400">ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰è¿½åŠ </span>
          </div>
          <button
            onClick={handleCreatePlan}
            className="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-full font-bold text-sm shadow-lg transition-all flex items-center gap-2"
          >
            <span className="material-symbols-outlined">auto_awesome</span>
            ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ
          </button>
        </div>
      )}
    </div>
  );
};

export const HotelList: React.FC<{ onNavigate: (path: string) => void }> = ({ onNavigate }) => {
  const [area, setArea] = useState<string>('æ±äº¬');
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [hotelName, setHotelName] = useState<string>('');
  const [checkIn, setCheckIn] = useState<string>('');
  const [checkOut, setCheckOut] = useState<string>('');
  const [numGuests, setNumGuests] = useState<number>(2);
  const [hotelCategories, setHotelCategories] = useState<HotelCategory[]>([]);
  const [searchResult, setSearchResult] = useState<HotelSearchResult | null>(null);
  const [isSearching, setIsSearching] = useState(false);

  useEffect(() => {
    const fetchCategories = async () => {
      try {
        const result = await hotelApi.getHotelCategories();
        setHotelCategories(result.categories);
      } catch (err) {
        console.error('Failed to fetch hotel categories:', err);
      }
    };
    fetchCategories();
  }, []);

  const handleSearch = async () => {
    setIsSearching(true);
    try {
      const searchRequest: HotelSearchRequest = {
        area,
        category: selectedCategory || undefined,
        hotelName: hotelName || undefined,
        checkIn: checkIn || undefined,
        checkOut: checkOut || undefined,
        numGuests
      };

      const result = await hotelApi.searchHotels(searchRequest);
      setSearchResult(result);
    } catch (err: any) {
      console.error('Failed to search hotels:', err);
      alert(err.detail || err.message || 'å®¿æ³Šæ–½è¨­ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsSearching(false);
    }
  };

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-8 py-10">
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <aside className="lg:col-span-1 lg:sticky lg:top-24 self-start space-y-6">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="font-bold text-lg mb-6 flex items-center gap-2">
              <span className="material-symbols-outlined text-primary">filter_alt</span> æ¤œç´¢æ¡ä»¶
            </h3>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium mb-1 block">ã‚¨ãƒªã‚¢</label>
                <input
                  type="text"
                  placeholder="ä¾‹: æ±äº¬ã€å¤§é˜ªã€äº¬éƒ½"
                  className="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm"
                  value={area}
                  onChange={e => setArea(e.target.value)}
                />
              </div>

              <div>
                <label className="text-sm font-medium mb-1 block">å®¿æ³Šæ–½è¨­ã®ç¨®é¡</label>
                <select
                  className="w-full rounded-lg border-gray-200 text-sm"
                  value={selectedCategory || ''}
                  onChange={e => setSelectedCategory(e.target.value || null)}
                >
                  <option value="">ã™ã¹ã¦</option>
                  {hotelCategories.map(cat => (
                    <option key={cat.name} value={cat.name}>{cat.icon} {cat.name}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="text-sm font-medium mb-1 block">ãƒ›ãƒ†ãƒ«åï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                <input
                  type="text"
                  placeholder="ä¾‹: é¹¿å…å³¶ä¸­å¤®é§…å‰ãƒ›ãƒ†ãƒ«"
                  className="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm"
                  value={hotelName}
                  onChange={e => setHotelName(e.target.value)}
                />
              </div>

              <div>
                <label className="text-sm font-medium mb-1 block">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥</label>
                <input
                  type="date"
                  className="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm"
                  value={checkIn}
                  onChange={e => setCheckIn(e.target.value)}
                  min={new Date().toISOString().split('T')[0]}
                />
              </div>

              <div>
                <label className="text-sm font-medium mb-1 block">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥</label>
                <input
                  type="date"
                  className="w-full px-3 py-2 rounded-lg border border-gray-200 text-sm"
                  value={checkOut}
                  onChange={e => setCheckOut(e.target.value)}
                  min={checkIn || new Date().toISOString().split('T')[0]}
                />
              </div>

              <div>
                <label className="text-sm font-medium mb-1 block">äºˆç´„äººæ•°</label>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => setNumGuests(Math.max(1, numGuests - 1))}
                    className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"
                  >
                    -
                  </button>
                  <span className="flex-1 text-center font-bold">{numGuests}å</span>
                  <button
                    onClick={() => setNumGuests(Math.min(20, numGuests + 1))}
                    className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"
                  >
                    +
                  </button>
                </div>
              </div>

              <button
                onClick={handleSearch}
                disabled={isSearching || !area}
                className="w-full bg-primary text-white py-3 rounded-full font-bold shadow-lg hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isSearching ? 'æ¤œç´¢ä¸­...' : 'æ¤œç´¢'}
              </button>
            </div>
          </div>
        </aside>

        <div className="lg:col-span-3">
          <h1 className="text-3xl font-bold mb-2">{area}ã®ãƒ›ãƒ†ãƒ«</h1>
          <p className="text-text-muted mb-6">AIãŒãŠã™ã™ã‚ã™ã‚‹ã€ã‚ãªãŸã®æ—…ã«ã´ã£ãŸã‚Šã®ãƒ›ãƒ†ãƒ«ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼</p>

          {searchResult ? (
            <div className="space-y-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <h3 className="font-bold text-lg mb-4">äºˆç´„ã‚µã‚¤ãƒˆã§æ¤œç´¢</h3>
                <div className="grid grid-cols-1 gap-4">
                  {searchResult.links.rakuten && !searchResult.links.rakuten.error && (
                    <a
                      href={searchResult.links.rakuten.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-4 p-4 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors"
                    >
                      <span className="text-3xl">ğŸ¨</span>
                      <div className="flex-1">
                        <p className="font-bold">æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ã§æ¤œç´¢</p>
                        <p className="text-sm text-text-muted">{searchResult.links.rakuten.description}</p>
                      </div>
                      <span className="material-symbols-outlined text-red-500">open_in_new</span>
                    </a>
                  )}
                  {searchResult.links.yahoo && !searchResult.links.yahoo.error && (
                    <a
                      href={searchResult.links.yahoo.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors"
                    >
                      <span className="text-3xl">ğŸ¨</span>
                      <div className="flex-1">
                        <p className="font-bold">Yahoo!ãƒˆãƒ©ãƒ™ãƒ«ã§æ¤œç´¢</p>
                        <p className="text-sm text-text-muted">{searchResult.links.yahoo.description}</p>
                      </div>
                      <span className="material-symbols-outlined text-blue-500">open_in_new</span>
                    </a>
                  )}
                  {searchResult.links.jalan && !searchResult.links.jalan.error && (
                    <a
                      href={searchResult.links.jalan.link}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-4 p-4 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors"
                    >
                      <span className="text-3xl">ğŸ¨</span>
                      <div className="flex-1">
                        <p className="font-bold">ã˜ã‚ƒã‚‰ã‚“ã§æ¤œç´¢</p>
                        <p className="text-sm text-text-muted">{searchResult.links.jalan.description}</p>
                      </div>
                      <span className="material-symbols-outlined text-green-500">open_in_new</span>
                    </a>
                  )}
                </div>
                {searchResult.errors && searchResult.errors.length > 0 && (
                  <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p className="text-sm font-bold text-yellow-800 mb-1">ä¸€éƒ¨ã®æ¤œç´¢ã«å•é¡ŒãŒã‚ã‚Šã¾ã™:</p>
                    {searchResult.errors.map((error, i) => (
                      <p key={i} className="text-xs text-yellow-700">- {error.affiliate}: {error.error}</p>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ) : (
            <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center">
              <span className="material-symbols-outlined text-6xl text-gray-300 mb-4">hotel</span>
              <p className="text-text-muted">å·¦å´ã®æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ã€å®¿æ³Šæ–½è¨­ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
